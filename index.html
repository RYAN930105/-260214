<!DOCTYPE html>
<html>
<head>
    <title>PokÃ©mon Masters: Ultimate Edition</title>
    <style>
        :root { --p-gold: #f1c40f; --p-bg: #1e272e; --p-panel: #2f3640; --p-red: #e74c3c; --p-blue: #3498db; --p-green: #2ecc71; }
        body { background: var(--p-bg); color: white; font-family: "Microsoft JhengHei", sans-serif; margin: 0; }
        
        .nav-bar { background: #000; padding: 15px; display: flex; justify-content: space-around; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid var(--p-gold); flex-wrap: wrap; }
        .nav-item { cursor: pointer; padding: 8px 12px; border-radius: 5px; background: #333; margin: 2px; }
        .resources { background: #3d3d3d; padding: 10px; display: flex; justify-content: center; gap: 15px; font-size: 0.8rem; flex-wrap: wrap; border-bottom: 1px solid #555; }
        
        .screen { display: none; padding: 20px; max-width: 1000px; margin: auto; animation: fadeIn 0.3s; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .adventure-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .adventure-card { background: #2c3e50; border: 2px solid #34495e; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; }
        .adventure-card:hover { transform: translateY(-5px); border-color: var(--p-gold); box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3); }
        .adventure-card.rocket:hover { border-color: var(--p-red); box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); }

        .slot-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .slot-card { background: var(--p-panel); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid #444; position: relative; }
        .iv-badge { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 10px; font-size: 10px; color: var(--p-gold); }
        .poke-img { width: 80px; height: 80px; object-fit: contain; }

        /* --- æˆ°é¬¥è¦–è¦ºé‡æ§‹ --- */
/* æˆ°é¬¥èˆå°å®¹å™¨ */
.battle-stage { 
    width: 100%; 
    max-width: 900px; 
    margin: auto; 
    border: 5px solid #333; 
    border-radius: 15px; 
    position: relative; 
    overflow: hidden; 
    height: 400px; /* å›ºå®šé«˜åº¦è®“ Flex å¥½åˆ†é… */
}

.battle-bg { 
    position: absolute; 
    inset: 0; 
    z-index: 0; 
    background-size: cover; 
    background-position: center; 
    filter: brightness(0.7); 
}


/* UI é…ç½®ï¼šå‚ç›´åˆ†ä½ˆ */
.battle-ui { 
    position: relative; 
    z-index: 2; 
    height: 100%; 
    display: flex; 
    flex-direction: column; 
    justify-content: space-between; /* è®“å…§å®¹æ•£é–‹ï¼šé ­ã€ä¸­ã€å°¾ */
    padding: 20px;
    box-sizing: border-box;
}

/* åœ–ç‰‡é€šç”¨è¨­å®š */
.battle-poke-img { 
    width: 140px; 
    height: 140px; 
    object-fit: contain; 
    animation: pokeBreath 3s ease-in-out infinite;
    /* æ–°å¢é€™è¡Œï¼šè®“æ‰€æœ‰æ”¹è®Š(ç¸®å°ã€æ—‹è½‰ã€é€æ˜åº¦)éƒ½åœ¨ 0.5 ç§’å…§å¹³æ»‘å®Œæˆ */
    transition: all 0.5s ease-in-out;
}

/* æ•µæ–¹å€å¡Šï¼šé å³å°é½Š */
.enemy-zone {
    display: flex;
    flex-direction: column;
    align-items: flex-end; /* é å³ */
}

/* ç©å®¶å€å¡Šï¼šæ”¹ç‚ºæ°´å¹³æ’åˆ— */
.player-zone {
    display: flex;
    flex-direction: row; /* è®“åœ–ç‰‡å’Œè³‡è¨Š/æŒ‰éˆ•æ©«è‘—æ’ */
    align-items: flex-end; /* åº•éƒ¨å°é½Š */
    gap: 15px; /* åœ–ç‰‡èˆ‡æŒ‰éˆ•é–“çš„è·é›¢ */
}

/* åŒ…è£¹åå­—ã€è¡€æ¢å’ŒæŒ‰éˆ•çš„å®¹å™¨ */
.player-info-wrapper {
    display: flex;
    flex-direction: column; /* è³‡è¨Šèˆ‡æŒ‰éˆ•å‚ç›´æ’ */
    align-items: flex-start;
}

/* è®“æŒ‰éˆ•æ©«å‘æ’é–‹ */
#battleActions {
    display: flex;
    gap: 8px;
    margin-top: 5px;
}
#battleMsg {
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
    min-height: 20px;
}

/* æ¢å¾© UI å…§çµ„ä»¶çš„é»æ“ŠåŠŸèƒ½ */
.enemy-info, .player-info, #battleMsg, #battleActions, #catchMenu {
    pointer-events: auto;
}

/* å‹•ç•«å®šç¾© */
.slide-in-left { animation: slideInLeft 0.8s ease-out forwards, pokeBreath 3s ease-in-out infinite 0.8s; }
.slide-in-right { animation: slideInRight 0.8s ease-out forwards, pokeBreath 3s ease-in-out infinite 0.8s; }

@keyframes slideInLeft { 
    from { transform: translateX(-150%); opacity: 0; } 
    to { transform: translateX(0); opacity: 1; } 
}
@keyframes slideInRight { 
    from { transform: translateX(150%); opacity: 0; } 
    to { transform: translateX(0); opacity: 1; } 
}
@keyframes pokeBreath {
    0%, 100% { filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6)); }
    50% { transform: translateY(-10px) scale(1.05); filter: drop-shadow(0 20px 30px rgba(0,0,0,0.4)); }
}

        /* å—æ“Šæ•ˆæœ (Flash) */
        .hit-flash { filter: brightness(3) contrast(2) !important; }

        .hp-bar-bg { width: 250px; background: #444; height: 12px; border: 2px solid #000; border-radius: 6px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.4s ease, background-color 0.3s; background-color: var(--p-green); }

        .dmg-popup { position: absolute; color: #ffeb3b; font-weight: bold; font-size: 38px; text-shadow: 3px 3px 0px #000; animation: damageFloat 0.8s forwards; z-index: 100; pointer-events: none; }
        @keyframes damageFloat { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } 
        }

        /* UI ä½ˆå±€å¾®èª¿ */
        .enemy-info { align-self: flex-end; text-align: right; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; }
        .player-info { align-self: flex-start; text-align: left; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .shop-item { background: #3d3d3d; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid var(--p-gold); }
        
        button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; margin: 2px; }
        .btn-gold { background: var(--p-gold); color: black; }
        .btn-red { background: var(--p-red); color: white; }
        .btn-blue { background: var(--p-blue); color: white; }
        .btn-green { background: var(--p-green); color: white; }
        
        .quest-box { background: #444; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--p-gold); }
        #gachaResult { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 10px; color: #ccc; margin: 5px 0; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item" onclick="showScreen('team')">ğŸ›¡ï¸ éšŠä¼</div>
        <div class="nav-item" onclick="showScreen('nurture')">ğŸ  å€‰åº«</div>
        <div class="nav-item" onclick="showScreen('battle_map')">âš”ï¸ å†’éšª</div>
        <div class="nav-item" onclick="showScreen('quests')">ğŸ“‹ ä»»å‹™</div>
        <div class="nav-item" onclick="showScreen('shop')">ğŸ’° å•†åº—</div>
        <div class="nav-item" onclick="showScreen('dex')">ğŸ“– åœ–é‘‘</div>
    </div>

    <div class="resources">
        <span>ğŸ’° é‡‘å¹£: <span id="resGold">0</span></span>
        <span>ğŸ æœå¯¦: <span id="resFood">0</span></span>
        <span>ğŸ’ é€²åŒ–çŸ³: <span id="resStone">0</span></span>
        <span>âš¾ æ™®é€šçƒ: <span id="ball1">0</span></span>
        <span>âš¾ è¶…ç´šçƒ: <span id="ball2">0</span></span>
        <span>âš¾ é«˜ç´šçƒ: <span id="ball3">0</span></span>
        <span>ğŸ§ª è—¥æ°´: <span id="pot1">0</span></span>
        <span>ğŸ§ª å…¨æ»¿è—¥: <span id="pot2">0</span></span>
        <span>ğŸ—¡ï¸ æ”»æ“Šå¢å¹…: <span id="resAtkBuff">0</span>%</span>
    </div>

    <div id="screen-team" class="screen active-screen">
        <h3>ç›®å‰éšŠä¼ <small>(æ¯åˆ†é˜è‡ªå‹•å›è¡€ 10 æ»´)                                               </small>
        <button onclick="healAll()" class="btn-blue" style="margin: 10px 30px; padding: 10px 10px;">
    ğŸ¥ ä¸€éµæ¢å¾©å…¨éšŠ (æ¶ˆè€— 50 é‡‘å¹£)</button></h3>

        <div class="slot-container" id="teamSlots"></div>
    </div>

    <div id="screen-nurture" class="screen">
        <h3>å¯¶å¯å¤¢å€‰åº« <span id="storageCount"></span></h3>
        <div class="slot-container" id="storageSlots"></div>
    </div>

    <div id="screen-battle_map" class="screen">
        <h2 style="text-align: center; color: var(--p-gold);">é¸æ“‡å†’éšªå€åŸŸ</h2>
        <div class="adventure-grid">
            <div class="adventure-card" onclick="initBattle('wild')">
                <div style="font-size: 40px;">ğŸŒ¿</div>
                <h2>é‡ç”Ÿè‰å¢</h2>
                <small>æ•æ‰æ–°å¤¥ä¼´</small>
            </div>
            <div class="adventure-card rocket">
                <div style="font-size: 40px;">ğŸš€</div>
                <h2>ç«ç®­éšŠåŸºåœ°</h2>
<select id="rocketLv" style="margin-top:10px; padding: 5px; border-radius: 5px; background: #444; color: white; border: 1px solid var(--p-gold);">
    <option value="1">Lv 1 - å˜å›‰ </option>
    <option value="3">Lv 2 - å¤–å‹¤å°å…µ</option>
    <option value="5">Lv 3 - è³‡æ·±åµå¯Ÿå“¡</option>       //å¤§ç´„æ•´éšŠ LV.20 æ‰“çš„è´
    <option value="7">Lv 4 - åŸºåœ°å®ˆè¡›</option>
    <option value="9">Lv 5 - ç«ç®­éšŠç²¾è‹±</option>
    <option value="11">Lv 6 - å½±å­å¹¹éƒ¨ </option>
    <option value="13">Lv 7 - åœ°å€ç¸½ç£</option>
    <option value="15">Lv 8 - ä¸‰ç¸å£«ç´š</option>
    <option value="17">Lv 9 - å‚æœ¨æ¥ç­äºº</option>
    <option value="20">Lv 10 - åœ°æ¿çµ‚çµè€… </option>
</select>
                <br>
                <button onclick="initBattle('rocket')" class="btn-red" style="margin-top:10px; padding: 8px 20px;">é–‹æ‰“</button>
            </div>
        </div>
    </div>

 <div id="screen-battle_stage" class="screen">
    <div class="battle-stage" id="battleBox">
        <div id="battleBg" class="battle-bg"></div>
        
        <div class="battle-ui">
            <div class="enemy-zone">
                <div style="background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px; text-align: right;">
                    <span id="eName"></span> <span id="eLv" style="color: var(--p-gold);"></span>
                    <div style="width:150px; background:#444; height:8px; margin-top:5px; border-radius: 4px; overflow: hidden;">
                        <div id="eHp" style="background:var(--p-green); height:100%; width:100%; transition: 0.3s;"></div>
                    </div>
                </div>
                <img id="eImg" src="" class="battle-poke-img">
            </div>

            <div class="info-zone">
                <div id="battleMsg">æº–å‚™æˆ°é¬¥...</div>
            </div>

            <div class="player-zone">
                <img id="pImg" src="" class="battle-poke-img">
                <div style="background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px;">
                    <span id="pName"></span> <span id="pLv" style="color: var(--p-gold);"></span>
                    <div style="width:150px; background:#444; height:8px; margin-top:5px; border-radius: 4px; overflow: hidden;">
                        <div id="pHp" style="background:var(--p-green); height:100%; width:100%; transition: 0.3s;"></div>
                    </div>
                </div>
                <div id="battleActions" style="margin-top: 10px;">
                    <button onclick="execAttack()" class="btn-red" style="padding:10px 25px">æ”»æ“Š</button>
                    <button id="catchBtn" onclick="openCatchMenu()" class="btn-gold">æ•æ‰</button>
                    <button id="runBtn" onclick="showScreen('battle_map')" class="btn-blue">é€ƒè·‘</button>
                </div>
                <div id="catchMenu" style="display:none; background:rgba(0,0,0,0.9); padding:10px; border-radius: 10px; margin-top: 5px;">
                    <button onclick="execCatch(1)" class="btn-gold">æ™®é€šçƒ</button>
                    <button onclick="execCatch(2)" class="btn-gold">è¶…ç´šçƒ</button> 
                    <button onclick="execCatch(3)" class="btn-gold">é«˜ç´šçƒ</button>
                    <button onclick="document.getElementById('catchMenu').style.display='none'">âŒ</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <div id="screen-quests" class="screen">
        <div class="quest-box" style="background: #2c3e50; border-color: var(--p-blue);">
            <strong>ğŸ•’ è‡ªå‹•æ›æ©Ÿç‹€æ…‹</strong><br>
            ç›®å‰æ¯åˆ†é˜æ”¶ç›Šï¼šğŸ’° 1 é‡‘å¹£ <br>
            <small id="lastSaveMsg">ä¸Šæ¬¡åŒæ­¥æ™‚é–“ï¼šè¼‰å…¥ä¸­...</small>
        </div>
        <h3>æ¯æ—¥ä»»å‹™ (æ‰‹å‹•é ˜å–)</h3>
        <div id="questList"></div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="quest-box" style="background:#444; border-color:var(--p-gold)">
            è¼¸å…¥å„ªæƒ ç¢¼: <input type="text" id="promoCode"> <button onclick="usePromo()" class="btn-gold">å…Œæ›</button>
        </div>
        <h3>å•†åº—èˆ‡æ“´å……</h3>
        <div class="shop-grid">
            <div class="shop-item">éš¨æ©ŸæŠ½ç<br>ğŸ’° 500<button onclick="buyItem('gacha', 500)" class="btn-gold">æŠ½å–</button></div>
            <div class="shop-item">æœå¯¦ x10<br>ğŸ’° 200<button onclick="buyItem('food10', 200)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">æœå¯¦ x100 (ç‰¹æƒ )<br>ğŸ’° 1500<button onclick="buyItem('food100', 1500)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">æ“´å……éšŠä¼æ ¼(+1)<br>ğŸ’° 5000<button onclick="buyItem('teamExp', 5000)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">æ“´å……å€‰åº«æ ¼(+5)<br>ğŸ’° 2000<button onclick="buyItem('storeExp', 2000)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">æ°¸ä¹…æ”»æ“ŠåŠ› +1%<br>ğŸ’° 3000<button onclick="buyItem('atkBuff', 3000)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">æ™®é€šçƒ ğŸ’°50<button onclick="buyItem('ball1',50)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">è¶…ç´šçƒ ğŸ’°150<button onclick="buyItem('ball2',150)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">é«˜ç´šçƒ ğŸ’°400<button onclick="buyItem('ball3',400)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">å›å¾©è—¥ ğŸ’°30<button onclick="buyItem('pot1',30)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">å…¨æ»¿è—¥ ğŸ’°100<button onclick="buyItem('pot2',100)" class="btn-gold">è³¼è²·</button></div>
            <div class="shop-item">é€²åŒ–çŸ³ ğŸ’°500<button onclick="buyItem('stone',500)" class="btn-gold">è³¼è²·</button></div>
        </div>
    </div>

    <div id="screen-dex" class="screen">
        <h3>å·²ç™¼ç¾åœ–é‘‘</h3>
        <div class="slot-container" id="dexList"></div>
    </div>

    <div id="gachaResult">
        <h2 style="color:var(--p-gold)">æ­å–œç²å¾—ï¼</h2>
        <div id="gachaInfo" class="slot-card" style="width:250px"></div>
        <button onclick="document.getElementById('gachaResult').style.display='none'" style="margin-top:20px; padding:10px 30px">ç¢ºå®š</button>
    </div>

    <script>
const POKE_BASE = {
    // --- å‰µä¸–ç¥èˆ‡ç¦å‚³ç´š (HP 130+, ç¸½å’Œæ¥µé«˜) (T0ï¼šæ•¸å€¼é ‚å³°) ---
    "é˜¿çˆ¾å®™æ–¯": { hp:150, atk:45, mAtk:45, def:40, mDef:40, evo:1 },
    "ç„¡æ¥µæ±°é‚£": { hp:140, atk:35, mAtk:50, def:35, mDef:35, evo:1 },
    "å¥ˆå…‹æ´›èŒ²ç‘ª": { hp:100, atk:45, mAtk:45, def:35, mDef:30, evo:4 },
    "çƒˆç©ºå": { hp:120, atk:40, mAtk:40, def:30, mDef:30, evo:2 },
    "å¸ç‰™ç›§å¡": { hp:120, atk:40, mAtk:40, def:30, mDef:30, evo:2 },
    "å¸•è·¯å¥‡äº": { hp:120, atk:40, mAtk:40, def:30, mDef:30, evo:2 },
    "é¨æ‹‰å¸ç´": { hp:120, atk:40, mAtk:40, def:30, mDef:30, evo:2 },
    "è“‹æ­å¡": { hp:125, atk:35, mAtk:45, def:30, mDef:35, evo:2 },
    "å›ºæ‹‰å¤š": { hp:125, atk:45, mAtk:35, def:35, mDef:30, evo:2 },
    "èŠå¸Œæ‹‰å§†": { hp:110, atk:35, mAtk:45, def:30, mDef:35, evo:1 },
    "æ·å…‹ç¾…å§†": { hp:110, atk:45, mAtk:35, def:35, mDef:30, evo:1 },
    "é…‹é›·å§†": { hp:125, atk:40, mAtk:40, def:25, mDef:25, evo:1 },
    "è¶…å¤¢": { hp:110, atk:35, mAtk:45, def:25, mDef:25, evo:3 },
    "éœ²å¥ˆé›…æ‹‰": { hp:130, atk:30, mAtk:45, def:25, mDef:35, evo:1 },
    "æ•…å‹’é “": { hp:110, atk:45, mAtk:25, def:35, mDef:30, evo:1 },
    "å¯†å‹’é “": { hp:110, atk:25, mAtk:45, def:30, mDef:35, evo:1 },
    "å¤ªæ¨‚å·´æˆˆæ–¯": { hp:110, atk:30, mAtk:30, def:35, mDef:35, evo:3 },

    // --- åœ°å€å‚³èªªèˆ‡æ‚–è«–ç¨® (HP 90-110) ---(T1ï¼šå¼·åŠ›æˆ°åŠ›) ---
    "è’¼éŸ¿": { hp:95, atk:45, mAtk:25, def:30, mDef:30, evo:2 },
    "è—ç‘ªç„¶ç‰¹": { hp:95, atk:25, mAtk:25, def:45, mDef:45, evo:2 },
    "ç‚å¸": { hp:115, atk:38, mAtk:30, def:25, mDef:20, evo:1 },
    "é›·å…¬": { hp:100, atk:30, mAtk:38, def:20, mDef:25, evo:1 },
    "æ°´å›": { hp:110, atk:25, mAtk:30, def:35, mDef:35, evo:1 },
    "æ€¥å‡é³¥": { hp:100, atk:25, mAtk:35, def:30, mDef:35, evo:2 },
    "é–ƒé›»é³¥": { hp:100, atk:30, mAtk:38, def:25, mDef:25, evo:2 },
    "ç«ç„°é³¥": { hp:100, atk:35, mAtk:35, def:25, mDef:25, evo:2 },
    "é¾æ²é›²": { hp:85, atk:35, mAtk:38, def:20, mDef:25, evo:1 },
    "é›·é›»é›²": { hp:85, atk:35, mAtk:38, def:20, mDef:25, evo:1 },
    "åœŸåœ°é›²": { hp:95, atk:40, mAtk:35, def:25, mDef:20, evo:1 },
    "æ‹‰å¸äºæ–¯": { hp:90, atk:25, mAtk:35, def:30, mDef:40, evo:2 },
    "æ‹‰å¸æ­æ–¯": { hp:90, atk:35, mAtk:40, def:25, mDef:30, evo:2 },
    "å…‹é›·è‰²åˆ©äº": { hp:120, atk:20, mAtk:25, def:35, mDef:40, evo:1 },
    "ç´¢çˆ¾è¿¦é›·æ­": { hp:100, atk:35, mAtk:25, def:30, mDef:25, evo:1 },
    "å¤¢å¹»": { hp:100, atk:30, mAtk:30, def:30, mDef:30, evo:1 },
    "è½Ÿé³´æœˆ": { hp:105, atk:42, mAtk:15, def:25, mDef:30, evo:1 },
    "éµæ­¦è€…": { hp:80, atk:40, mAtk:40, def:25, mDef:20, evo:1 },

    // --- æº–ç¥èˆ‡ç¨€æœ‰é¾æ— (å¤šéšæ®µé€²åŒ–) ---(T2ï¼šç©å®¶æ ¸å¿ƒ) ---
    "å¹¼åŸºæ‹‰æ–¯": { hp:70, atk:25, mAtk:15, def:25, mDef:20, evo:4 },
    "åœ“é™¸é¯Š": { hp:75, atk:25, mAtk:20, def:20, mDef:15, evo:4 },
    "è¿·ä½ é¾": { hp:65, atk:22, mAtk:22, def:18, mDef:18, evo:3 },
    "å¤šé¾æ¢…è¥¿äº": { hp:60, atk:25, mAtk:20, def:15, mDef:15, evo:3 },
    "ç‰™ç‰™": { hp:65, atk:30, mAtk:10, def:20, mDef:15, evo:3 },

    // --- å¾¡ä¸‰å®¶ç³»åˆ— (å„ä»£ä¸»è§’ï¼Œæ•¸å€¼å‡è¡¡å„ªè³ª) ---(T2ï¼šç©å®¶æ ¸å¿ƒ) ---
    "å°ç«é¾": { hp:70, atk:22, mAtk:22, def:18, mDef:18, evo:6 },
    "å¦™è›™ç¨®å­": { hp:75, atk:18, mAtk:22, def:20, mDef:20, evo:5 },
    "å‚‘å°¼é¾œ": { hp:80, atk:20, mAtk:20, def:25, mDef:22, evo:5 },
    "ç«çƒé¼ ": { hp:70, atk:22, mAtk:22, def:18, mDef:18, evo:4 },
    "èŠè‰è‘‰": { hp:75, atk:18, mAtk:20, def:22, mDef:22, evo:3 },
    "å°å·¨é±·": { hp:85, atk:25, mAtk:15, def:20, mDef:18, evo:3 },
    "æ°´èºé­š": { hp:85, atk:24, mAtk:18, def:20, mDef:18, evo:4 },
    "ç«é›‰é›": { hp:70, atk:25, mAtk:22, def:15, mDef:15, evo:4 },
    "è‰æ¨¹é¾œ": { hp:90, atk:25, mAtk:15, def:25, mDef:20, evo:3 },
    "å°ç«ç„°çŒ´": { hp:70, atk:24, mAtk:24, def:15, mDef:15, evo:3 },
    "æ³¢åŠ æ›¼": { hp:75, atk:18, mAtk:25, def:20, mDef:22, evo:3 },
    "é¨°é¨°è›‡": { hp:75, atk:20, mAtk:22, def:22, mDef:22, evo:3 },
    "æš–æš–è±¬": { hp:100, atk:25, mAtk:15, def:15, mDef:15, evo:3 },
    "æ°´æ°´çº": { hp:80, atk:22, mAtk:22, def:18, mDef:18, evo:4 },
    "ç«æ–‘å–µ": { hp:75, atk:25, mAtk:15, def:18, mDef:18, evo:3 },
    "æœ¨æœ¨æ¢Ÿ": { hp:85, atk:20, mAtk:20, def:22, mDef:22, evo:3 },
    "çƒçƒæµ·ç…": { hp:75, atk:15, mAtk:25, def:18, mDef:22, evo:3 },
    "ç‚å…”å…’": { hp:70, atk:25, mAtk:15, def:15, mDef:15, evo:4 },
    "æ•²éŸ³çŒ´": { hp:85, atk:25, mAtk:15, def:20, mDef:18, evo:4 },
    "æ·šçœ¼èœ¥": { hp:70, atk:15, mAtk:25, def:15, mDef:18, evo:4 },
    "æ–°è‘‰è²“": { hp:70, atk:24, mAtk:18, def:18, mDef:18, evo:3 },
    "å‘†ç«é±·": { hp:100, atk:18, mAtk:24, def:25, mDef:22, evo:3 },
    "æ½¤æ°´é´¨": { hp:85, atk:25, mAtk:15, def:20, mDef:15, evo:3 },

    // --- ä¼Šå¸ƒå®¶æ— (ç›¸é—œæ€§é›†ä¸­) ---(åŠŸèƒ½æ€§å…¨é½Š) ---
    "ä¼Šå¸ƒ": { hp:65, atk:20, mAtk:20, def:18, mDef:20, evo:2 },
    "æ°´ä¼Šå¸ƒ": { hp:110, atk:20, mAtk:35, def:20, mDef:30, evo:1 },
    "é›·ä¼Šå¸ƒ": { hp:75, atk:20, mAtk:38, def:15, mDef:25, evo:1 },
    "ç«ä¼Šå¸ƒ": { hp:75, atk:38, mAtk:30, def:15, mDef:30, evo:1 },
    "å¤ªé™½ä¼Šå¸ƒ": { hp:75, atk:20, mAtk:40, def:15, mDef:25, evo:1 },
    "æœˆäº®ä¼Šå¸ƒ": { hp:100, atk:20, mAtk:20, def:35, mDef:40, evo:1 },
    "è‘‰ä¼Šå¸ƒ": { hp:75, atk:35, mAtk:15, def:38, mDef:20, evo:1 },
    "å†°ä¼Šå¸ƒ": { hp:75, atk:15, mAtk:38, def:35, mDef:20, evo:1 },
    "ä»™å­ä¼Šå¸ƒ": { hp:95, atk:20, mAtk:35, def:20, mDef:40, evo:1 },

    // --- åœ°å€åŠŸèƒ½çµ„ (å¦‚ä¸‰çŒ´ã€å±¬æ€§æ€ªã€åŠŸèƒ½æ€ª) ---
    "èŠ±æ¤°çŒ´": { hp:65, atk:20, mAtk:20, def:15, mDef:15, evo:2 },
    "çˆ†é¦™çŒ´": { hp:65, atk:20, mAtk:20, def:15, mDef:15, evo:2 },
    "å†·æ°´çŒ´": { hp:65, atk:20, mAtk:20, def:15, mDef:15, evo:2 },
    "è¿·å”‡å§Š": { hp:85, atk:15, mAtk:35, def:12, mDef:28, evo:1 },
    "é´¨å˜´ç«ç¸": { hp:85, atk:30, mAtk:35, def:20, mDef:25, evo:1 },
    "æ‹‰æ™®æ‹‰æ–¯": { hp:115, atk:25, mAtk:28, def:25, mDef:30, evo:2 },
    "å‡±ç¾…æ–¯": { hp:85, atk:38, mAtk:15, def:30, mDef:20, evo:2 },
    "åˆ©æ­è·¯": { hp:65, atk:25, mAtk:15, def:15, mDef:15, evo:3 },
    "å°è²“æ€ª": { hp:60, atk:25, mAtk:15, def:15, mDef:15, evo:3 },
    "ç‡­å…‰éˆ": { hp:60, atk:10, mAtk:30, def:20, mDef:20, evo:3 },
    "æˆ´é­¯æ¯”": { hp:65, atk:22, mAtk:25, def:15, mDef:15, evo:3 },

    // --- åŸºç¤èˆ‡å¸¸è¦‹æˆå“¡ ---(T3ï¼šå†’éšªèµ·é») ---
    "å°¼å¤šæœ—": { hp:60, atk:22, mAtk:15, def:15, mDef:15, evo:3 },
    "å°¼å¤šè˜­": { hp:65, atk:18, mAtk:15, def:18, mDef:18, evo:3 },
    "èµ°è·¯è‰": { hp:60, atk:15, mAtk:25, def:18, mDef:18, evo:3 },
    "å–‡å­èŠ½": { hp:60, atk:25, mAtk:22, def:12, mDef:12, evo:3 },
    "è“®è‘‰ç«¥å­": { hp:60, atk:12, mAtk:18, def:15, mDef:18, evo:3 },
    "å¸•å¥‡åˆ©èŒ²": { hp:75, atk:15, mAtk:15, def:22, mDef:25, evo:1 },
    "çš®å¡ä¸˜": { hp:65, atk:22, mAtk:22, def:15, mDef:15, evo:4 },
    "å°æ‹³çŸ³": { hp:75, atk:28, mAtk:10, def:38, mDef:10, evo:4 },
    "è…•åŠ›": { hp:85, atk:32, mAtk:10, def:20, mDef:15, evo:4 },
    "ç¨è§’èŸ²": { hp:55, atk:15, mAtk:10, def:12, mDef:10, evo:4 },
    "é¯‰é­šç‹": { hp:40, atk:40, mAtk:5, def:15, mDef:10, evo:3 },
    "é¬¼æ–¯": { hp:50, atk:10, mAtk:35, def:10, mDef:15, evo:2 },
    "è€¿é¬¼": { hp:80, atk:20, mAtk:45, def:20, mDef:25, evo:3 }
};


        let user = {
            gold: 1000, food: 100, ball1: 10, ball2: 5, ball3: 2, pot1: 10, pot2: 5, stone: 0, atkBuff: 0,
            teamLimit: 3, storeLimit: 20,
            team: [], storage: [], dex: [], lastTime: Date.now(),
            q_catch: 0, q_rocket: 0, q_time: 0, q_claimed: []
        };

        let bState = { active: false, enemy: null, player: null, type: '', pIdx: 0 };

        function init() {
            const saved = localStorage.getItem('poke_master_save');
            if(saved) {
                user = JSON.parse(saved);
            }
            const now = Date.now();
            if(user.lastTime && now > user.lastTime) {
                const elapsedMins = Math.floor((now - user.lastTime) / 60000);
                if(elapsedMins > 0) {
                    const goldEarned = elapsedMins * 1;
                    user.gold += goldEarned;
                    user.team.concat(user.storage).forEach(p => { 
                        if(p) p.hp = Math.min(p.hpMax, p.hp + elapsedMins * 10); 
                    });
                    setTimeout(() => {
                        alert(`æ­¡è¿å›ä¾†ï¼ä½ é›¢ç·šäº† ${elapsedMins} åˆ†é˜\nç²å¾—æ”¶ç›Šï¼šğŸ’° ${goldEarned} é‡‘å¹£\nå¯¶å¯å¤¢é«”åŠ›æ¢å¾©äº† ${elapsedMins * 10}ï¼`);
                    }, 500);
                }
            }
            if(user.team.length === 0 && user.storage.length === 0) user.team.push(createPoke("å°ç«é¾", 1));
            setInterval(() => {
                user.team.concat(user.storage).forEach(p => { if(p && p.hp < p.hpMax) p.hp = Math.min(p.hpMax, p.hp + 10); });
                user.q_time += 1;
                updateUI();
                save();
            }, 60000);
            updateUI();
        }

        function save() {
            user.lastTime = Date.now();
            localStorage.setItem('poke_master_save', JSON.stringify(user));
            const msgEl = document.getElementById('lastSaveMsg');
            if(msgEl) msgEl.innerText = "ä¸Šæ¬¡åŒæ­¥æ™‚é–“ï¼š" + new Date().toLocaleTimeString();
        }

        function createPoke(species, lv = 1) {
            const base = POKE_BASE[species] || {hp:70, atk:20, mAtk:20, def:15, mDef:15, evo:1};
            const iv = 0.8 + Math.random() * 0.4;
            const ivScore = Math.floor(((iv - 0.8) / 0.4) * 100);
            return {
                id: Date.now() + Math.random(),
                name: species, lv: lv, phase: 1,
                hpMax: Math.floor(base.hp * iv + lv * 2), hp: Math.floor(base.hp * iv + lv * 2),
                atk: Math.floor(base.atk * iv + lv), mAtk: Math.floor(base.mAtk * iv + lv),
                def: Math.floor(base.def * iv + lv/2), mDef: Math.floor(base.mDef * iv + lv/2),
                iv: ivScore
            };
        }

        window.buyItem = (type, price) => {
            if(user.gold < price) return alert("éŒ¢ä¸å¤ ï¼");
            user.gold -= price;
            if(type === 'food10') user.food += 10;
            if(type === 'food100') user.food += 100;
            if(type === 'teamExp') { if(user.teamLimit < 6) user.teamLimit++; else alert("å·²é”éšŠä¼ä¸Šé™(6éš»)"); }
            if(type === 'storeExp') { if(user.storeLimit < 100) user.storeLimit += 5; else alert("å·²é”å€‰åº«ä¸Šé™(100éš»"); }
            if(type === 'atkBuff') user.atkBuff += 1;
            if(type === 'ball1') user.ball1 += 1;
            if(type === 'ball2') user.ball2 += 1;
            if(type === 'ball3') user.ball3 += 1;
            if(type === 'pot1') user.pot1 += 1;
            if(type === 'pot2') user.pot2 += 1;
            if(type === 'stone') user.stone += 1;
            if(type === 'gacha') execGacha();
            save(); updateUI();
        };

        function execGacha() {
            const list = Object.keys(POKE_BASE);
            const sp = list[Math.floor(Math.random() * list.length)];
            const p = createPoke(sp, 1);
            if(!user.dex.includes(sp)) user.dex.push(sp);
            if(user.storage.length < user.storeLimit) {
                user.storage.push(p);
                document.getElementById('gachaResult').style.display = 'flex';
                document.getElementById('gachaInfo').innerHTML = `<img src="${p.name}1.png" class="poke-img"><br><b>${p.name}</b><br>IV è©•åˆ†: ${p.iv}`;
            } else alert("å€‰åº«æ»¿äº†ï¼");
        }

        /* --- è¦–è¦ºç‰¹æ•ˆå‡½æ•¸ --- */
        function applyHit(targetId, dmg) {
            const img = document.getElementById(targetId);
            img.classList.add('hit-flash');
            setTimeout(() => img.classList.remove('hit-flash'), 150);

            const popup = document.createElement('div');
            popup.className = 'dmg-popup';
            popup.innerText = `-${dmg}`;
            const box = document.getElementById('battleBox');
            popup.style.left = targetId === 'eImg' ? '70%' : '30%';
            popup.style.top = targetId === 'eImg' ? '20%' : '60%';
            box.appendChild(popup);
            setTimeout(() => popup.remove(), 800);
        }

        function updateBarColor(elId, pct) {
            const el = document.getElementById(elId);
            if(pct > 50) el.style.backgroundColor = 'var(--p-green)';
            else if(pct > 20) el.style.backgroundColor = '#f39c12';
            else el.style.backgroundColor = 'var(--p-red)';
        }

        window.initBattle = (type) => {
            bState.type = type;
            bState.pIdx = 0;
            bState.player = user.team[0];
            if(!bState.player) return alert("éšŠä¼ç¬¬ä¸€æ ¼å¿…é ˆæœ‰å¯¶å¯å¤¢ï¼");
            if(bState.player.hp <= 0) {
                // è‡ªå‹•å°‹æ‰¾ç¬¬ä¸€éš»æœ‰è¡€çš„
                const firstAlive = user.team.findIndex(p => p.hp > 0);
                if(firstAlive === -1) return alert("å…¨å“¡å¤±å»æˆ°é¬¥èƒ½åŠ›ï¼è«‹å…ˆä½¿ç”¨è—¥æ°´æˆ–ç­‰å¾…å›è¡€ã€‚");
                bState.pIdx = firstAlive;
                bState.player = user.team[firstAlive];
            }

            if(type === 'wild') {
                const sps = Object.keys(POKE_BASE);
                bState.enemy = createPoke(sps[Math.floor(Math.random()*sps.length)], bState.player.lv);
                document.getElementById('catchBtn').style.display = 'inline-block';
                document.getElementById('runBtn').style.display = 'none';
            } else {
// --- ç«ç®­éšŠé‚è¼¯ï¼šå¤šæ¨£åŒ–ä¿®å¾© ---
        const rLv = parseInt(document.getElementById('rocketLv').value);
        
        // 1. å®šç¾©ç«ç®­éšŠå¯èƒ½æœƒå‡ºçš„å¯¶å¯å¤¢
        const rocketPokes = ["é˜¿çˆ¾å®™æ–¯","ç„¡æ¥µæ±°é‚£","å¥ˆå…‹æ´›èŒ²ç‘ª","çƒˆç©ºå","å¸ç‰™ç›§å¡","å¸•è·¯å¥‡äº","é¨æ‹‰å¸ç´","è“‹æ­å¡","å›ºæ‹‰å¤š","èŠå¸Œæ‹‰å§†","æ·å…‹ç¾…å§†","é…‹é›·å§†","è¶…å¤¢","éœ²å¥ˆé›…æ‹‰"];
        // 2. éš¨æ©ŸæŠ½ä¸€éš»
        const randomSpecies = rocketPokes[Math.floor(Math.random() * rocketPokes.length)];
        
        // 3. æ ¹æ“šé›£åº¦ç”Ÿæˆï¼ˆrLv * 50 è®“é›£åº¦å¢åŠ ä¸€é»ï¼‰
        bState.enemy = createPoke(randomSpecies, bState.player.lv + (rLv * 50));
                bState.enemy.name = "ç«ç®­éšŠçš„" + bState.enemy.name;
                document.getElementById('catchBtn').style.display = 'none';
                document.getElementById('runBtn').style.display = 'inline-block';
            }

// éš¨æ©Ÿç¾æ™¯ (ä½¿ç”¨æœ¬åœ° bg1~5.png)
const bgNum = Math.floor(Math.random() * 5) + 1; // éš¨æ©Ÿç”¢ç”Ÿ 1 åˆ° 5
document.getElementById('battleBg').style.backgroundImage = `url('bg${bgNum}.png')`;

            bState.active = true;
            showScreen('battle_stage');

            // 5. è§¸ç™¼é€²å ´å‹•ç•«
            const pi = document.getElementById('pImg');
            const ei = document.getElementById('eImg');
            pi.className = 'battle-poke-img slide-in-left';
            ei.className = 'battle-poke-img slide-in-right';            
            updateBattleUI();
            msg("æˆ°é¬¥é–‹å§‹ï¼é¢å°çš„æ˜¯ " + bState.enemy.name);
        };

        window.execAttack = () => {
            if(!bState.active) return;
            
            // ç©å®¶æ”»æ“Š
            const buff = 1 + (user.atkBuff / 100);
            const pDmg = Math.floor((bState.player.atk * buff) + Math.random()*10);
            bState.enemy.hp -= pDmg;
            
            applyHit('eImg', pDmg);
            updateBattleUI();
            msg(`æˆ‘çš„ ${bState.player.name} é€ æˆ ${pDmg} å‚·å®³ï¼`);

            if(bState.enemy.hp <= 0) { 
                bState.enemy.hp = 0; 
                updateBattleUI(); 
                setTimeout(win, 800); 
                return; 
            }

            // æ•µäººåæ“Š
            bState.active = false; // æš«æ™‚é–å®šæŒ‰éˆ•
            setTimeout(() => {
                if(!bState.enemy) return;
                const eDmg = Math.max(5, Math.floor(bState.enemy.atk - bState.player.def/2));
                bState.player.hp -= eDmg;
                
                applyHit('pImg', eDmg);
                updateBattleUI();
                msg(`${bState.enemy.name} åæ“Šé€ æˆ ${eDmg} å‚·å®³ï¼`);

                if(bState.player.hp <= 0) {
                    bState.player.hp = 0;
                    updateBattleUI();
                    // æ¥åŠ›é‚è¼¯
                    const nextIdx = user.team.findIndex((p, i) => i > bState.pIdx && p.hp > 0);
                    if(nextIdx !== -1) {
                        bState.pIdx = nextIdx;
                        bState.player = user.team[nextIdx];
                        msg(`${user.team[nextIdx-1].name} å€’ä¸‹äº†ï¼æ¥åŠ›å§ï¼Œ${bState.player.name}ï¼`);
                        
                        // æ¥åŠ›é€²å ´å‹•ç•«
                        const pImg = document.getElementById('pImg');
                        pImg.classList.remove('slide-in-left');
                        void pImg.offsetWidth;
                        pImg.classList.add('slide-in-left');
                        updateBattleUI();
                        bState.active = true;
                    } else {
                        msg("éšŠä¼å·²å…¨å“¡å€’ä¸‹...");
                        bState.active = false;
                        setTimeout(() => showScreen('team'), 2000);
                    }
                } else {
                    bState.active = true;
                }
                save();
            }, 800);
        };

        window.openCatchMenu = () => { document.getElementById('catchMenu').style.display = 'block'; };

window.execCatch = (ballType) => {
    const key = 'ball' + ballType;
    if(user[key] <= 0) return alert("æ²’çƒäº†");
    
    // é–å®šæ“ä½œï¼Œé˜²æ­¢æŠ•çƒä¸­é€”äº‚é»æŒ‰éˆ•
    if(!bState.active) return; 

    user[key]--;
    const multi = [0, 0.5, 1, 1.5][ballType];
    const chance = ((1 - bState.enemy.hp/bState.enemy.hpMax) * 0.3 + 0.02) * multi;
    
    document.getElementById('catchMenu').style.display = 'none';
    msg("æŠ•çƒä¸­...");
    
    // å‹•ç•«é–‹å§‹
    const eImg = document.getElementById('eImg');
    eImg.style.transition = "all 0.8s ease-in-out"; // ç¢ºä¿ CSS é€™è£¡æœ‰å¹³æ»‘éæ¸¡
    eImg.style.transform = "scale(0.2) rotate(360deg)";
    eImg.style.opacity = "0.5";

    setTimeout(() => {
        if(Math.random() < chance) {
            msg("æ•æ‰æˆåŠŸ " + bState.enemy.name + "ï¼");
            
            // æŠ“æ•å¾Œçš„å¯¶å¯å¤¢åå­—è™•ç†
            let captured = createPoke(bState.enemy.name.replace(/ç«ç®­éšŠ|çš„/g, ""), 1);
            
            if(!user.dex.includes(captured.name)) user.dex.push(captured.name);
            user.q_catch++;
            
            if(user.storage.length < user.storeLimit) {
                user.storage.push(captured);
            } else {
                msg("å€‰åº«å·²æ»¿ï¼Œå¯¶å¯å¤¢é€ƒèµ°äº†...");
            }
            
            bState.active = false; 
            save();
            setTimeout(() => showScreen('team'), 1200);
        } else {
            msg("è¢«æ™è„«äº†ï¼");
            // æ¢å¾©å‹•ç•«
            eImg.style.transform = "scale(1) rotate(0deg)";
            eImg.style.opacity = "1";
            
            // é‡è¦ï¼šæ™è„«å¾Œï¼Œå¿…é ˆäº¤çµ¦æ•µæ–¹å›åˆæ”»æ“Šç©å®¶
            setTimeout(() => {
                enemyTurn(); 
            }, 800); 
        }
        updateUI();
    }, 1000);
};
        function win() {
            bState.active = false;
            let gold = bState.type === 'wild' ? 120 : 100 * (parseInt(document.getElementById('rocketLv').value));
            let food = Math.floor(Math.random() * 20) + 5;
            user.gold += gold; user.food += food;
            if(bState.type === 'rocket') user.q_rocket++;
            msg(`å‹åˆ©ï¼ç²å¾— $${gold} èˆ‡ æœå¯¦x${food}`);
            save();
            setTimeout(() => showScreen('team'), 1500);
        }

        window.toTeam = (id) => {
            if(user.team.length >= user.teamLimit) return alert("éšŠä¼å·²æ»¿");
            const idx = user.storage.findIndex(p => p.id === id);
            if(idx > -1) user.team.push(user.storage.splice(idx, 1)[0]);
            save(); updateUI();
        };

        window.toStore = (id) => {
            const idx = user.team.findIndex(p => p.id === id);
            if(idx > -1) user.storage.push(user.team.splice(idx, 1)[0]);
            save(); updateUI();
        };

        window.feed = (id, isTeam) => {
            if(user.food < 10) return alert("æœå¯¦ä¸è¶³(éœ€10å€‹)");
            const list = isTeam ? user.team : user.storage;
            const p = list.find(x=>x.id===id);
            user.food -= 10; p.lv++; p.hpMax += 10; p.hp = p.hpMax; p.atk += 2; p.mAtk += 2; p.def += 1; p.mDef += 1;
            save(); updateUI();
        };

        window.usePot = (id, type) => {
           const p = user.team.concat(user.storage).find(x => x.id === id);
            if(p.hp < 10 && type === 1) {
                if(user.pot2 > 0) { user.pot2--; p.hp = p.hpMax; alert("è¡€é‡éä½ï¼Œä½¿ç”¨äº†å…¨æ»¿è—¥ï¼"); }
                else if(user.pot1 > 0) { user.pot1--; p.hp = Math.min(p.hpMax, p.hp + 50); alert("ä½¿ç”¨äº†æ™®é€šè—¥æ°´"); }
                else alert("è—¥æ°´ä¸è¶³ï¼");
            } else {
                const k = 'pot' + type;
                if(user[k] <= 0) return alert("è—¥æ°´ä¸è¶³");
                user[k]--; p.hp = (type === 1) ? Math.min(p.hpMax, p.hp + 50) : p.hpMax;
            }
            save(); updateUI();
        };

        window.evolve = (id) => {
            const p = user.team.concat(user.storage).find(x => x.id === id);
            const base = POKE_BASE[p.name];
            if(p.lv < 10) return alert("ç­‰ç´šéœ€é” 10 ä»¥ä¸Šæ‰èƒ½é€²åŒ–");
            if(user.stone <= 0) return alert("é€²åŒ–çŸ³ä¸è¶³");
            if(p.phase >= (base.evo || 1)) return alert("å·²é”æœ€çµ‚é€²åŒ–");
            user.stone--; p.phase++; p.atk = Math.floor(p.atk * 1.2); p.mAtk = Math.floor(p.mAtk * 1.2); p.hpMax = Math.floor(p.hpMax * 1.2); p.hp = p.hpMax;
            alert("é€²åŒ–æˆåŠŸï¼"); save(); updateUI();
        };

        window.claimQuest = (type) => {
            if(type === 'catch' && user.q_catch >= 3) { user.gold += 500; user.q_catch -= 3; alert("é ˜å– 500 é‡‘å¹£ï¼"); }
            else if(type === 'rocket' && user.q_rocket >= 3) { user.stone += 1; user.q_rocket -= 3; alert("é ˜å– 1 é¡†é€²åŒ–çŸ³ï¼"); }
            else if(type === 'time' && user.q_time >= 10) { user.ball3 += 1; user.q_time -= 10; alert("é ˜å– 1 é¡†é«˜ç´šçƒï¼"); }
            else { alert("æ¢ä»¶æœªé”æˆ"); }
            save(); updateUI();
        };

        window.usePromo = () => {
            const code = document.getElementById('promoCode').value;
            if (code === "930105") { user.gold += 10000; user.food += 1000; user.stone += 100; user.ball1 += 100; user.ball2 += 100; user.ball3 += 100; user.pot1 += 100; user.pot2 += 100; alert("å¤§é‡è³‡æºå·²å…¥åº«ï¼"); }
            else if (code === "ryan") { user.gold += 1000; user.food += 100; user.stone += 5; user.ball1 += 15; user.ball2 += 10; user.ball3 += 5; user.pot1 += 10; user.pot2 += 5; alert("ç²å–å°‘é‡å…¨è³‡æºï¼"); }
            else if (code === "gold") { user.gold += 10000; alert("é‡‘å¹£ +10,000ï¼"); }
            else if (code === "food") { user.food += 1000; alert("æœå¯¦ +1,000ï¼"); }
            else { alert("ç„¡æ•ˆçš„å„ªæƒ ç¢¼ï¼"); }
            save(); updateUI();
            document.getElementById('promoCode').value = "";
        };

        window.release = (id) => {
            if(!confirm("ç¢ºå®šè¦æ”¾ç”Ÿå—ï¼Ÿ")) return;
            user.storage = user.storage.filter(p => p.id !== id);
            save(); updateUI();
        };

        function updateUI() {

    // --- æ–°å¢ï¼šè‡ªå‹•æ’åºé‚è¼¯ ---
    // æ ¹æ“šç­‰ç´š (lv) å¾å¤§åˆ°å°æ’åºï¼Œå¦‚æœç­‰ç´šç›¸åŒï¼Œå¯ä»¥å†æ¯” IV (é¸å¡«)
    user.team.sort((a, b) => b.lv - a.lv);
user.storage.sort((a, b) => {
    if (b.lv !== a.lv) {
        return b.lv - a.lv;
    }
    return b.iv - a.iv;
});
    // -----------------------

            document.getElementById('resGold').innerText = user.gold.toLocaleString();
            document.getElementById('resFood').innerText = user.food;
            document.getElementById('resStone').innerText = user.stone;
            document.getElementById('resAtkBuff').innerText = user.atkBuff;
            ['ball1','ball2','ball3','pot1','pot2'].forEach(k => { if(document.getElementById(k)) document.getElementById(k).innerText = user[k]; });
            document.getElementById('storageCount').innerText = `(${user.storage.length}/${user.storeLimit})`;
            renderList(user.team, 'teamSlots', true);
            renderList(user.storage, 'storageSlots', false);
            renderDex(); renderQuests();
        }

        function renderList(list, target, isTeam) {
            document.getElementById(target).innerHTML = list.map(p => `
                <div class="slot-card">
                    <div class="iv-badge">IV:${p.iv}</div>
                    <img src="${p.name}${p.phase}.png" class="poke-img" onerror="this.src='https://via.placeholder.com/80?text=Poke'">
                    <div style="font-size:12px"><b>${p.name}</b> Lv.${p.lv}</div>
                    <div class="stat-grid">
                        <span>ç‰©æ”»:${p.atk}</span><span>é­”æ”»:${p.mAtk}</span>
                        <span>ç‰©é˜²:${p.def}</span><span>é­”é˜²:${p.mDef}</span>
                    </div>
                    <div style="font-size:10px; color:#aaa">HP:${Math.floor(p.hp)}/${p.hpMax}</div>
                    <div style="margin-top:5px">
                        <button onclick="feed(${p.id}, ${isTeam})" class="btn-green">æœå¯¦</button>
                        <button onclick="usePot(${p.id}, 1)" class="btn-blue">è£œè¡€</button>
                        ${isTeam ? `<button onclick="toStore(${p.id})">å­˜å…¥</button>` : `<button onclick="toTeam(${p.id})" class="btn-gold">æ”¾å…¥éšŠä¼</button>`}
                        <button onclick="evolve(${p.id})" class="btn-gold">é€²åŒ–</button>
                        ${!isTeam ? `<button onclick="release(${p.id})" class="btn-red">æ”¾ç”Ÿ</button>` : ''}
                     </div>
                </div>
            `).join('');
        }

        function renderQuests() {
            const q = [
                { id: 'catch', t: "æ•æ‰å¯¶å¯å¤¢", c: user.q_catch, m: 3, r: "é‡‘å¹£ 500" },
                { id: 'rocket', t: "æŒ‘æˆ°ç«ç®­éšŠ", c: user.q_rocket, m: 3, r: "é€²åŒ–çŸ³ 1" },
                { id: 'time', t: "å†’éšªæ™‚é•·(åˆ†)", c: user.q_time, m: 10, r: "é«˜ç´šçƒ 1" }
            ];
            document.getElementById('questList').innerHTML = q.map(i => `
                <div class="quest-box">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <b>${i.t}</b> (${i.c}/${i.m}) <br> <small>çå‹µ: ${i.r}</small>
                        </div>
                        ${i.c >= i.m ? `<button onclick="claimQuest('${i.id}')" class="btn-green">é ˜å–çå‹µ</button>` : '<button disabled style="opacity:0.5">æœªé”æˆ</button>'}
                    </div>
                </div>
            `).join('');
        }

        function renderDex() {
            document.getElementById('dexList').innerHTML = Object.keys(POKE_BASE).map(sp => `
                <div class="slot-card" style="opacity: ${user.dex.includes(sp) ? 1 : 0.3}">
                    <img src="${sp}1.png" class="poke-img" onerror="this.src='https://via.placeholder.com/80?text=?'">
                    <div style="font-size:12px">${user.dex.includes(sp) ? sp : '???'}</div>
                </div>
            `).join('');
        }

function healAll() {
    if (user.gold < 50) return alert("é‡‘å¹£ä¸è¶³ï¼éœ€è¦ 50 é‡‘å¹£ã€‚");
    
    let healed = false;
    user.team.forEach(p => {
        // ç›´æ¥å°æ¯”ç•¶å‰ HP å’Œè©²å¯¶å¯å¤¢ç´€éŒ„çš„ hpMax
        // åªè¦ç•¶å‰è¡€é‡å°æ–¼æœ€å¤§è¡€é‡ï¼Œå°±ç›´æ¥å¡«æ»¿
        if (p.hp < p.hpMax) {
            p.hp = p.hpMax;
            healed = true;
        }
    });

    if (healed) {
        user.gold -= 50;
        updateUI();
        alert("éšŠä¼å·²æ¢å¾©å¥åº·ï¼");
    } else {
        alert("éšŠä¼å·²ç¶“æ˜¯æ»¿è¡€ç‹€æ…‹ã€‚");
    }
}

        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('screen-' + id).classList.add('active-screen');
            updateUI();
        }

        function updateBattleUI() { 
            if(!bState.enemy || !bState.player) return;
            
            const ePct = (bState.enemy.hp / bState.enemy.hpMax * 100);
            const pPct = (bState.player.hp / bState.player.hpMax * 100);
            
            document.getElementById('eHp').style.width = ePct + '%';
            document.getElementById('pHp').style.width = pPct + '%';
            
            updateBarColor('eHp', ePct);
            updateBarColor('pHp', pPct);

            document.getElementById('eName').innerText = bState.enemy.name;
            document.getElementById('eLv').innerText = "Lv." + bState.enemy.lv;
            document.getElementById('pName').innerText = bState.player.name;
            document.getElementById('pLv').innerText = "Lv." + bState.player.lv;
 
            const enemyPureName = bState.enemy.name.replace(/ç«ç®­éšŠ|çš„/g, "");
            const eImgEl = document.getElementById('eImg');
            const pImgEl = document.getElementById('pImg');
            
            if(eImgEl) { 
                eImgEl.src = `${enemyPureName}1.png`; 
                eImgEl.onerror = function() { this.src = 'https://via.placeholder.com/260?text=Enemy'; }; 
            }
            if(pImgEl) { 
                pImgEl.src = `${bState.player.name}${bState.player.phase}.png`; 
                pImgEl.onerror = function() { this.src = 'https://via.placeholder.com/260?text=Player'; }; 
            }
        }

        function msg(t) { document.getElementById('battleMsg').innerText = t; }
        window.addEventListener('beforeunload', save);
        init();
    </script>
</body>

</html>
